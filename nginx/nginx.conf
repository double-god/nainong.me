events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    gzip on;

    server {
        listen 80;

        # 1. 静态资源：使用精确前缀匹配，并放在最前面
        location /_astro/ {
            proxy_pass http://blog-frontend:80/_astro/;
            proxy_set_header Host $host;
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        # 2. 后端 API：修改正则，排除掉 _astro
        # 原本的 ~ ^/(api|_) 太宽泛了，会抓走所有下划线开头的请求
        location ~ ^/(api|_admin|_schema) {
            proxy_pass http://blog-backend:8090;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            client_max_body_size 10M;
        }

        # 3. 前端页面
        location / {
            proxy_pass http://blog-frontend:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}